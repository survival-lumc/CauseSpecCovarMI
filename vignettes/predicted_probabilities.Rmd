---
title: "On predicted probabilities"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{predicted_probabilities}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 6,
  fig.align = 'center',
  message = FALSE, 
  warning = FALSE
)
# see https://github.com/epiforecasts/WuhanSeedingVsTransmission/blob/master/vignettes/output.Rmd
```



```{r setup, message=FALSE}
library(SimsCauseSpecCovarMiss)
library(tidyverse)
library(mstate)

set.seed(123)

theme_set(theme_bw(base_size = 12) +
            theme(plot.title = element_text(hjust = 0.5)))
```


# Generate data


```{r gen_dat}
# Set weibull parameter globally as we will need them later
ev1_pars <- list("a1" = 2, "h1_0" = 1, 
                 "b1" = 1, "gamm1" = 1)

ev2_pars <- list("a2" = 2.5, "h2_0" = .5,
                 "b2" = .5, "gamm2" = .5)


# Lets start with a complete (large) dataset, with hardly any censoring
dat_full_contin <- generate_dat(n = 500,
                                X_type = "contin",
                                r = 0.1,
                                ev1_pars = ev1_pars,
                                ev2_pars = ev2_pars,
                                rate_cens = .01) 
```



```{r cox_long}
# Run both cause-specific models using mstate
cox_long <- setup_mstate(dat_full_contin)
cox_long
```


```{r grid_print}
# Make grid of covariate values at which to evaluate predictions
grid_obj <- make_covar_grid(dat_full_contin)
grid_obj
```


```{r grid_plot, dev='svg'}
grid_obj %>% 
  ggplot(aes(val_X, val_Z)) + geom_point() +
  labs(x = "X", y = "Z")
```


```{r pred_hor, warning=FALSE}
preds <- preds_mstate(cox_long = cox_long,
                      grid_obj = grid_obj, 
                      times = c(0.5, 1), 
                      ev1_pars = ev1_pars,
                      ev2_pars = ev2_pars)

head(preds) %>% 
  mutate_if(is.numeric, ~ round(., 3))
```


```{r trueplot_mean, dev='svg', warning=FALSE}
cumincs_plot_truepred(cox_long = cox_long, 
                      combo = data.frame("val_X" = 0, "val_Z" = 0),
                      ev1_pars,
                      ev2_pars, 
                      dat_full_contin)
```


```{r trueplot_high, dev='svg', warning=FALSE}
cumincs_plot_truepred(cox_long = cox_long, 
                      combo = data.frame("val_X" = 1, "val_Z" = 1),
                      ev1_pars,
                      ev2_pars, 
                      dat_full_contin)
```


```{r trueplot_low, dev='svg', warning=FALSE}
cumincs_plot_truepred(cox_long = cox_long, 
                      combo = data.frame("val_X" = -1, "val_Z" = -1),
                      ev1_pars,
                      ev2_pars, 
                      dat_full_contin)
```

